<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Smudge - A Tabby Cat Adventure</title>

    <!-- Define input system FIRST before anything else -->
    <script>
        // Map our button names to Kaboom key names
        const keyMap = {
            'up': 'ArrowUp',
            'down': 'ArrowDown',
            'left': 'ArrowLeft',
            'right': 'ArrowRight',
            'enter': 'Enter',
            'escape': 'Escape',
            'space': ' '
        };

        window.smudgeInput = {
            heldKeys: {},

            press: function(key) {
                this.heldKeys[key] = true;
                // Simulate actual keyboard event on window (Kaboom listens here)
                const mappedKey = keyMap[key] || key;
                console.log('Simulating keydown:', key, '→', mappedKey);
                const event = new KeyboardEvent('keydown', {
                    key: mappedKey,
                    code: mappedKey,
                    bubbles: true,
                    cancelable: true
                });
                // Try multiple targets to ensure Kaboom catches it
                window.dispatchEvent(event);
                document.dispatchEvent(event);
                // Also try the canvas if it exists
                const canvas = document.querySelector('canvas');
                if (canvas) {
                    canvas.dispatchEvent(event);
                }
            },

            release: function(key) {
                this.heldKeys[key] = false;
                // Simulate keyup
                const mappedKey = keyMap[key] || key;
                const event = new KeyboardEvent('keyup', {
                    key: mappedKey,
                    code: mappedKey,
                    bubbles: true,
                    cancelable: true
                });
                window.dispatchEvent(event);
                document.dispatchEvent(event);
                const canvas = document.querySelector('canvas');
                if (canvas) {
                    canvas.dispatchEvent(event);
                }
            },

            isDown: function(key) {
                return this.heldKeys[key] === true;
            }
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg1: #fff4e6;
            --bg2: #ffd7a8;
            --ink: #5c4033;
            --accent: #ff9966;
            --accent-2: #ffcc99;
            --warm: #d4a574;
        }
        html, body {
            height: 100%;
        }
        body {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(1200px 700px at 10% 10%, var(--bg1), transparent),
                        radial-gradient(1200px 700px at 90% 90%, var(--bg2), transparent),
                        #fff8f0;
            font-family: "Baloo 2", "Nunito", system-ui, -apple-system, sans-serif;
            color: var(--ink);
        }
        #frame {
            padding: 20px;
            padding-top: 30px;
            border-radius: 28px;
            background: #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,.08), inset 0 0 0 3px var(--accent-2);
        }

        /* More padding on mobile for better spacing */
        @media (max-width: 768px) {
            #frame {
                padding: 10px;
                padding-top: 20px;
            }
        }
        canvas {
            border-radius: 20px;
            display: block;
        }
        #info {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,.85);
            backdrop-filter: blur(8px);
            padding: 10px 14px;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,.08);
            font-weight: 800;
            letter-spacing: .3px;
            z-index: 1000;
        }

        /* Hide info bar on mobile */
        @media (max-width: 768px) {
            #info {
                display: none;
            }
        }
        .chip {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            background: var(--warm);
            margin-left: 8px;
        }

        /* Mobile Controls */
        #mobile-controls {
            display: none; /* Hidden by default */
            pointer-events: none;
            z-index: 1001;
        }

        /* Only show on touch devices */
        @media (pointer: coarse) {
            #mobile-controls {
                display: block;
            }
        }

        .control-group {
            position: fixed;
            pointer-events: auto;
        }

        /* D-Pad positioned in bottom-left corner */
        .control-group:first-child {
            bottom: 10px;
            left: 10px;
        }

        /* Action buttons positioned in bottom-right corner */
        .control-group:last-child {
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .dpad {
            display: grid;
            grid-template-columns: 45px 45px 45px;
            grid-template-rows: 45px 45px 45px;
            gap: 3px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(8px);
            border: 2px solid var(--accent-2);
            border-radius: 10px;
            font-weight: 900;
            font-size: 18px;
            color: var(--ink);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
            transition: all 0.1s;
        }

        .btn:active {
            transform: scale(0.95);
            background: var(--accent-2);
        }

        .btn-up { grid-column: 2; grid-row: 1; }
        .btn-down { grid-column: 2; grid-row: 3; }
        .btn-left { grid-column: 1; grid-row: 2; }
        .btn-right { grid-column: 3; grid-row: 2; }

        .btn-action {
            width: 45px;
            height: 45px;
        }

        .btn-a { background: rgba(255, 153, 102, 0.75); }
        .btn-b { background: rgba(255, 204, 153, 0.75); }
        .btn-space { background: rgba(212, 165, 116, 0.75); }
    </style>
</head>
<body>
    <div id="info">
        Find Smudge <span class="chip">tabby adventure</span> · D-Pad = Move · A = Select · B = Back
    </div>
    <div id="frame">
        <!-- Kaboom mounts here -->
        <script src="https://unpkg.com/kaboom@3000.0.1/dist/kaboom.js"></script>
        <script src="game.js?v=20251103-1300"></script>
    </div>

    <!-- Mobile Touch Controls -->
    <div id="mobile-controls">
        <!-- D-Pad -->
        <div class="control-group">
            <div class="dpad">
                <div class="btn btn-up" id="btn-up">↑</div>
                <div class="btn btn-left" id="btn-left">←</div>
                <div class="btn btn-right" id="btn-right">→</div>
                <div class="btn btn-down" id="btn-down">↓</div>
            </div>
        </div>

        <!-- Action Buttons inline with D-pad -->
        <div class="control-group">
            <div class="btn btn-action btn-space" id="btn-space">␣</div>
            <div class="btn btn-action btn-b" id="btn-b">B</div>
            <div class="btn btn-action btn-a" id="btn-a">A</div>
        </div>
    </div>

    <!-- Mobile control setup -->
    <script>
        function setupButton(id, key) {
            const btn = document.getElementById(id);
            if (!btn) {
                console.warn('Button not found:', id);
                return;
            }

            btn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                console.log('Touch pressed:', key);
                window.smudgeInput.press(key);
            }, { passive: false });

            btn.addEventListener('touchend', function(e) {
                e.preventDefault();
                console.log('Touch released:', key);
                window.smudgeInput.release(key);
            }, { passive: false });

            btn.addEventListener('mousedown', function(e) {
                e.preventDefault();
                console.log('Mouse pressed:', key);
                window.smudgeInput.press(key);
            });

            btn.addEventListener('mouseup', function(e) {
                e.preventDefault();
                console.log('Mouse released:', key);
                window.smudgeInput.release(key);
            });

            console.log('Button setup complete:', id, '→', key);
        }

        console.log('Starting mobile control setup...');
        setupButton('btn-up', 'up');
        setupButton('btn-down', 'down');
        setupButton('btn-left', 'left');
        setupButton('btn-right', 'right');
        setupButton('btn-a', 'enter');
        setupButton('btn-b', 'escape');
        setupButton('btn-space', 'space');
        console.log('Mobile control setup complete!');
    </script>
</body>
</html>
